{% extends 'base.html' %}
{% block content %}
{% load static %}
<script src="{% static 'js/get_address.js' %}"></script>

<div class="container">
    <div class="card mt-3">
        <div class="card-header">Nova Venda</div>
        <div class="card-body">
            <form method="post" id="saleForm">
                {% csrf_token %}
                <div class="row">
                    <!-- Nome da Venda -->
                    <div class="mb-2 col-8">
                        <label class="form-label">Nome:</label>
                        <input class="form-control" name="name" type="text" id="name" required />
                    </div>

                    <!-- Cliente -->
                    <div class="mb-2 col">
                        <label class="form-label">Cliente</label>
                        <select class="form-select" name="customer" required>
                            <option hidden selected disabled>Selecione</option>
                            <!-- Os clientes devem renderizar aqui -->
                        </select>
                    </div>
                </div>

                <!-- Campo de busca para produtos -->
                <div class="mb-3">
                    <label class="form-label">Buscar Produto</label>
                    <input type="text" class="form-control" id="productSearch" placeholder="Digite o nome do produto" />
                </div>

                <!-- Lista de resultados da busca -->
                <ul class="list-group mb-3" id="productResults"></ul>

                <!-- Produtos adicionados -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h5>Produtos Selecionados</h5>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Quantidade</th>
                                    <th>Preço Unitário</th>
                                    <th>Subtotal</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody id="selectedProducts">
                                <!-- Os produtos adicionados aparecerão aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Observações -->
                <label class="form-label">Observações</label>
                <textarea class="form-control" name="observations" rows="4"></textarea>

                <!-- Botão de enviar -->
                <button type="submit" class="btn btn-primary mt-3">Finalizar Venda</button>
            </form>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
    const apiUrl = "/api/products/"; // URL da API de produtos
    const productSearch = document.querySelector("#productSearch");
    const productResults = document.querySelector("#productResults");
    const selectedProducts = document.querySelector("#selectedProducts");
    let products = []; // Cache dos produtos retornados pela API
    let addedProducts = []; // Lista de produtos adicionados

    // Função para buscar produtos pela API
    async function fetchProducts(query) {
        if (!query) {
            productResults.innerHTML = "";
            return;
        }

        try {
            const response = await fetch(`${apiUrl}?search=${query}`);
            const data = await response.json();
            products = data.products || [];
            renderProductResults();
        } catch (error) {
            console.error("Erro ao buscar produtos:", error);
        }
    }

    // Função para renderizar resultados da busca
    function renderProductResults() {
        productResults.innerHTML = products
            .map(
                (product) => `  
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${product.name} - ${product.weight}${product.unit_type}, ${product.size}, ${product.quantity_per_package} folhas
                    <button type="button" class="btn btn-sm btn-success" onclick="addProduct(${product.id})">Adicionar</button>
                </li>
            `
            )
            .join("");
    }

    // Função para adicionar produto à tabela
    window.addProduct = function (productId) {
        const product = products.find((p) => p.id === productId);
        if (!product || addedProducts.find((p) => p.id === productId)) return;

        addedProducts.push({ ...product, quantity: 1 });
        renderSelectedProducts();
    };

    // Função para renderizar tabela de produtos selecionados
    function renderSelectedProducts() {
        selectedProducts.innerHTML = addedProducts
            .map(
                (product) => `
                <tr>
                    <td>${product.name}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm" value="${product.quantity}" min="1" 
                            onchange="updateQuantity(${product.id}, this.value)" />
                    </td>
                    <td>${product.weight}${product.unit_type}</td>
                    <td>${product.size}</td>
                    <td>${product.quantity_per_package}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeProduct(${product.id})">Remover</button>
                    </td>
                </tr>
            `
            )
            .join("");
    }

    // Função para atualizar quantidade de um produto
    window.updateQuantity = function (productId, quantity) {
        const product = addedProducts.find((p) => p.id === productId);
        if (product && quantity > 0) {
            product.quantity = parseInt(quantity, 10);
            renderSelectedProducts();
        }
    };

    // Função para remover um produto da tabela
    window.removeProduct = function (productId) {
        addedProducts = addedProducts.filter((p) => p.id !== productId);
        renderSelectedProducts();
    };

    // Evento de busca ao digitar
    productSearch.addEventListener("input", function () {
        const query = this.value.trim();
        fetchProducts(query);
    });

    // Formulário de venda
    const saleForm = document.querySelector("#saleForm");

    // Previne submissão até que todos os dados estejam processados
    saleForm.addEventListener("submit", async function (event) {
        event.preventDefault(); // Impede o reset da página

        // Captura os elementos
        const nameInput = document.querySelector("#name");
        const customerSelect = document.querySelector("[name='customer']");
        const observationsTextarea = document.querySelector("#observations");

        // Verifique se todos os campos obrigatórios existem no DOM
        if (!nameInput || !customerSelect) {
            console.error("Algum elemento obrigatório do formulário não foi encontrado no DOM.");
            return alert("Erro ao capturar os dados do formulário. Verifique o HTML.");
        }

        // Captura os valores do formulário
        const saleData = {
            name: nameInput.value.trim(),
            customer: customerSelect.value,
            observations: observationsTextarea ? observationsTextarea.value.trim() : "", // Observations é opcional
            products: addedProducts.map(product => ({
                id: product.id,
                quantity: product.quantity,
            })),
        };

        // Log dos dados capturados (debug)
        console.log("Dados da venda a ser enviada:", saleData);

        // Verifique se há produtos adicionados
        if (!saleData.products.length) {
            return alert("Adicione ao menos um produto antes de finalizar a venda.");
        }

        // Envia os dados via AJAX para a URL do back-end
        try {
            const response = await fetch("/add-sale/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}", // Substitua pelo token CSRF real no template Django
                },
                body: JSON.stringify(saleData),
            });

            const result = await response.json();

            // Tratamento de sucesso ou erro
            if (result.success) {
                alert("Venda registrada com sucesso!");
                location.reload(); // Recarrega a página após o sucesso
            } else {
                alert(`Erro ao registrar a venda: ${result.message}`);
            }
        } catch (error) {
            console.error("Erro ao registrar a venda:", error);
            alert("Ocorreu um erro ao tentar registrar a venda. Tente novamente.");
        }
    });
});

</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const customerApiUrl = "/api/customers/"; // URL da API de clientes
    const customerSelect = document.querySelector("[name='customer']");

    // Função para buscar clientes pela API
    async function fetchCustomers() {
        try {
            const response = await fetch(customerApiUrl);
            const data = await response.json();
            const customers = data.customers || [];
            renderCustomerOptions(customers);
        } catch (error) {
            console.error("Erro ao buscar clientes:", error);
        }
    }

    // Função para renderizar as opções de clientes
    function renderCustomerOptions(customers) {
        customerSelect.innerHTML = `
            <option hidden selected disabled>Selecione</option>
        `; // Reseta as opções existentes

        customers.forEach((customer) => {
            const option = document.createElement("option");
            option.value = customer.id;
            option.textContent = `${customer.name} (${customer.cpf_or_cnpj})`;
            customerSelect.appendChild(option);
        });
    }

    // Chamar a função para buscar clientes ao carregar a página
    fetchCustomers();
});
</script>
{% endblock %}
